version: "3.9"

services:
  app:
    build: .
    image: otel-go-webapp:latest
    environment:
      - ENV=dev
    ports:
      - "8080:8080"
    depends_on:
      - otel-collector

  otel-collector:
    image: otel/opentelemetry-collector:latest
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    ports:
      - "4317:4317"   # OTLP gRPC
      - "8889:8889"   # Prometheus metrics endpoint

  # Go Auto-Instrumentation agent container that attaches to the app process
  otel-go-agent:
    image: ghcr.io/open-telemetry/opentelemetry-go-instrumentation/autoinstrumentation-go:latest
    depends_on:
      - app
    pid: "service:app"
    restart: unless-stopped
    privileged: true
    security_opt:
      - apparmor:unconfined
    cap_add:
      - SYS_ADMIN
      - SYS_PTRACE
      - SYS_RESOURCE
      - PERFMON
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=otel-collector:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_SERVICE_NAME=otel-go-webapp
      - OTEL_RESOURCE_ATTRIBUTES=deployment.environment=dev
      - OTEL_GO_AUTO_INSTRUMENTATION_HTTP_ENABLED=true
      - OTEL_GO_AUTO_INSTRUMENTATION_RUNTIME_ENABLED=true
      # Target the app's executable path inside the app container
      - OTEL_GO_AUTO_TARGET_EXE=/usr/local/bin/server
    volumes:
      - /sys/kernel/debug:/sys/kernel/debug
      - /sys/fs/bpf:/sys/fs/bpf
      - /sys/kernel/tracing:/sys/kernel/tracing
